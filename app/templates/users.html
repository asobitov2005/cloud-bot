{% extends "base.html" %}

{% block users_active %}active{% endblock %}
{% block page_title %}Users Management{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-users"></i> Users Management</h1>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-main);">All Users</h3>
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Search users..."
                oninput="searchUsers()" />
        </div>
    </div>
</div>

<div class="modern-table-container">
    <table class="modern-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Telegram ID</th>
                <th>Username</th>
                <th>Full Name</th>
                <th>Joined</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <tr>
                <td colspan="8" class="text-center" style="padding: 3rem;">
                    <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                    Loading users...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="paginationControls" class="pagination-container" style="display: none;">
    <button class="pagination-btn" id="prevBtn" onclick="changePage(-1)">
        <i class="fas fa-chevron-left"></i> Previous
    </button>
    <span id="pageInfo" class="page-info" style="color: var(--text-muted); font-weight: 500;"></span>
    <button class="pagination-btn" id="nextBtn" onclick="changePage(1)">
        Next <i class="fas fa-chevron-right"></i>
    </button>
</div>

<!-- Make Admin Modal -->
<div id="makeAdminModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
    <div class="modal-content"
        style="background-color: var(--bg-card); margin: 10% auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); position: relative;">
        <span class="close" onclick="closeMakeAdminModal()"
            style="color: var(--text-muted); float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 1.5rem; color: var(--text-main);">Make User Admin</h2>
        <p style="margin-bottom: 1rem; color: var(--text-muted);">Select permissions to grant to this user:</p>
        <form id="makeAdminForm" onsubmit="makeAdminWithPermissions(event)">
            <input type="hidden" id="adminUserId" />
            <div id="permissionsList"
                style="max-height: 400px; overflow-y: auto; margin: 15px 0; padding: 1rem; background: var(--bg-input); border-radius: var(--radius-md);">
                <!-- Permissions checkboxes will be added here -->
            </div>
            <div style="margin-top: 15px; display: flex; gap: 0.5rem;">
                <button type="button" onclick="selectAllPermissions()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main); font-size: 0.875rem;">Select
                    All</button>
                <button type="button" onclick="deselectAllPermissions()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main); font-size: 0.875rem;">Deselect
                    All</button>
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeMakeAdminModal()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main);">Cancel</button>
                <button type="submit" class="btn btn-primary">Make Admin</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Permissions Modal -->
<div id="editPermissionsModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
    <div class="modal-content"
        style="background-color: var(--bg-card); margin: 10% auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); position: relative;">
        <span class="close" onclick="closeEditPermissionsModal()"
            style="color: var(--text-muted); float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 1.5rem; color: var(--text-main);">Edit Admin Permissions</h2>
        <form id="editPermissionsForm" onsubmit="updatePermissions(event)">
            <input type="hidden" id="editPermissionsUserId" />
            <div id="editPermissionsList"
                style="max-height: 400px; overflow-y: auto; margin: 15px 0; padding: 1rem; background: var(--bg-input); border-radius: var(--radius-md);">
                <!-- Permissions checkboxes will be added here -->
            </div>
            <div style="margin-top: 15px; display: flex; gap: 0.5rem;">
                <button type="button" onclick="selectAllEditPermissions()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main); font-size: 0.875rem;">Select
                    All</button>
                <button type="button" onclick="deselectAllEditPermissions()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main); font-size: 0.875rem;">Deselect
                    All</button>
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeEditPermissionsModal()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main);">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Permissions</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUsers = [];
    let searchTimeout;
    let currentPage = 1;
    let totalUsers = 0;
    let usersPerPage = 50;

    async function loadUsers(page = 1) {
        currentPage = page;
        const skip = (page - 1) * usersPerPage;
        const searchQuery = document.getElementById('searchInput').value.trim();

        let url = `/admin/api/users?skip=${skip}&limit=${usersPerPage}`;
        if (searchQuery) {
            url += `&search=${encodeURIComponent(searchQuery)}`;
        }

        try {
            const res = await fetch(url, {
                credentials: 'same-origin'
            });
            if (!res.ok) await handleApiError(res);
            const data = await res.json();
            currentUsers = data.users;
            totalUsers = data.total || 0;
            renderUsers(currentUsers);
            renderPagination();
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    function renderUsers(users) {
        const tbody = document.getElementById('usersTableBody');

        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 3rem; color: var(--text-muted);">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                        No users found
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td>${user.telegram_id}</td>
                <td>
                    <div style="max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@${user.username || 'N/A'}">
                        @${user.username || 'N/A'}
                    </div>
                </td>
                <td>
                    <div style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${user.full_name || 'Unknown'}">
                        ${user.full_name || 'Unknown'}
                    </div>
                </td>
                
                <td>${new Date(user.joined_at).toLocaleDateString()}</td>
                <td style="min-width: 150px;">
                    ${user.is_primary_admin ?
                '<span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"><i class="fas fa-crown"></i> Super Admin</span>' :
                user.is_admin ?
                    `<div>
                        <span class="badge" style="background: #667eea; color: white; cursor: pointer; transition: opacity 0.2s;" onclick="editPermissions(${user.id})" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'"><i class="fas fa-shield-alt"></i> Admin <i class="fas fa-edit" style="font-size: 0.8em; margin-left: 5px;"></i></span>
                        ${user.permissions && user.permissions.length > 0 ?
                        '<div style="margin-top: 5px;"><small style="font-size: 0.75em; color: #666; display: block; word-break: break-word;">' + user.permissions.join(', ') + '</small></div>' :
                        '<div style="margin-top: 5px;"><small style="font-size: 0.75em; color: #999;">No permissions</small></div>'
                    }
                    </div>` :
                    '<span class="badge badge-secondary"><i class="fas fa-user"></i> User</span>'
            }
                </td>
                <td>
                    ${user.is_blocked ?
                '<span class="badge badge-blocked"><i class="fas fa-lock" style="margin-right: 4px;"></i> Blocked</span>' :
                '<span class="badge badge-active"><i class="fas fa-check-circle" style="margin-right: 4px;"></i> Active</span>'
            }
                </td>
                <td style="white-space: nowrap; min-width: 250px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                        ${user.is_blocked ?
                `<button class="action-btn" onclick="unblockUser(${user.id})" title="Unblock User" style="color: #10b981;"><i class="fas fa-unlock"></i></button>` :
                `<button class="action-btn" onclick="blockUser(${user.id})" title="Block User" style="color: #ef4444;"><i class="fas fa-ban"></i></button>`
            }
                        ${!user.is_primary_admin ?
                (user.is_admin ?
                    `<button class="action-btn" onclick="removeAdmin(${user.id})" title="Remove Admin" style="color: #f59e0b;"><i class="fas fa-user-minus"></i></button>` :
                    `<button class="action-btn" onclick="showMakeAdminModal(${user.id})" title="Make Admin" style="color: #6366f1;"><i class="fas fa-user-shield"></i></button>`) :
                ''
            }
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Debounced search function
    function searchUsers() {
        clearTimeout(searchTimeout);

        const query = document.getElementById('searchInput').value.trim();

        if (query === '') {
            loadUsers(1);
            return;
        }

        searchTimeout = setTimeout(() => {
            loadUsers(1);
        }, 500); // 500ms debounce
    }

    function renderPagination() {
        const paginationControls = document.getElementById('paginationControls');
        const pageInfo = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        const totalPages = Math.ceil(totalUsers / usersPerPage);

        // Hide pagination if only one page or no users
        if (totalPages <= 1) {
            paginationControls.style.display = 'none';
            return;
        }

        paginationControls.style.display = 'flex';
        pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

        // Disable/enable buttons
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
    }

    function changePage(delta) {
        const newPage = currentPage + delta;
        const totalPages = Math.ceil(totalUsers / usersPerPage);

        if (newPage >= 1 && newPage <= totalPages) {
            loadUsers(newPage);
            // Scroll to top of table
            const table = document.querySelector('.modern-table-container');
            if (table) {
                table.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
    }

    async function blockUser(userId) {
        showConfirmDialog(
            'Are you sure you want to block this user?',
            async () => {
                try {
                    const res = await fetch(`/admin/api/users/${userId}/block`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    if (!res.ok) await handleApiError(res);

                    loadUsers();
                    showNotification('User blocked successfully!', 'success');
                } catch (error) {
                    console.error('Error blocking user:', error);
                    showNotification('Error blocking user', 'error');
                }
            }
        );
    }

    async function unblockUser(userId) {
        try {
            const res = await fetch(`/admin/api/users/${userId}/unblock`, {
                method: 'POST',
                credentials: 'same-origin'
            });
            if (!res.ok) await handleApiError(res);

            loadUsers();
            showNotification('User unblocked successfully!', 'success');
        } catch (error) {
            console.error('Error unblocking user:', error);
            showNotification('Error unblocking user', 'error');
        }
    }

    const PERMISSIONS = {
        upload: "Upload Files",
        delete: "Delete Files",
        stats: "View Statistics",
        users: "Manage Users",
        broadcast: "Send Broadcasts",
        settings: "Manage Settings",
        fsub: "Manage Force Join Channels"
    };

    function showMakeAdminModal(userId) {
        document.getElementById('adminUserId').value = userId;
        const permissionsList = document.getElementById('permissionsList');
        permissionsList.innerHTML = Object.entries(PERMISSIONS).map(([key, label]) => `
            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="permission" value="${key}" style="margin-right: 10px;">
                    <span>${label}</span>
                </label>
            </div>
        `).join('');
        document.getElementById('makeAdminModal').style.display = 'block';
    }

    function closeMakeAdminModal() {
        document.getElementById('makeAdminModal').style.display = 'none';
        document.getElementById('makeAdminForm').reset();
    }

    function selectAllPermissions() {
        document.querySelectorAll('#permissionsList input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    function deselectAllPermissions() {
        document.querySelectorAll('#permissionsList input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    async function makeAdminWithPermissions(event) {
        event.preventDefault();
        const userId = parseInt(document.getElementById('adminUserId').value);
        const selectedPermissions = Array.from(document.querySelectorAll('#permissionsList input[type="checkbox"]:checked'))
            .map(cb => cb.value);

        try {
            const res = await fetch(`/admin/api/users/${userId}/make-admin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ permissions: selectedPermissions })
            });
            if (!res.ok) await handleApiError(res);

            closeMakeAdminModal();
            loadUsers();
            showNotification('User promoted to admin successfully!', 'success');
        } catch (error) {
            console.error('Error making user admin:', error);
            showNotification('Error promoting user to admin', 'error');
        }
    }

    function editPermissions(userId) {
        const user = currentUsers.find(u => u.id === userId);
        if (!user) return;

        document.getElementById('editPermissionsUserId').value = userId;
        const permissionsList = document.getElementById('editPermissionsList');
        const userPermissions = user.permissions || [];

        permissionsList.innerHTML = Object.entries(PERMISSIONS).map(([key, label]) => `
            <div style="margin: 10px 0;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" name="permission" value="${key}" ${userPermissions.includes(key) ? 'checked' : ''} style="margin-right: 10px;">
                    <span>${label}</span>
                </label>
            </div>
        `).join('');
        document.getElementById('editPermissionsModal').style.display = 'block';
    }

    function closeEditPermissionsModal() {
        document.getElementById('editPermissionsModal').style.display = 'none';
    }

    function selectAllEditPermissions() {
        document.querySelectorAll('#editPermissionsList input[type="checkbox"]').forEach(cb => cb.checked = true);
    }

    function deselectAllEditPermissions() {
        document.querySelectorAll('#editPermissionsList input[type="checkbox"]').forEach(cb => cb.checked = false);
    }

    async function updatePermissions(event) {
        event.preventDefault();
        const userId = parseInt(document.getElementById('editPermissionsUserId').value);
        const selectedPermissions = Array.from(document.querySelectorAll('#editPermissionsList input[type="checkbox"]:checked'))
            .map(cb => cb.value);

        try {
            const res = await fetch(`/admin/api/users/${userId}/permissions`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({ permissions: selectedPermissions })
            });
            if (!res.ok) await handleApiError(res);

            closeEditPermissionsModal();
            loadUsers();
            showNotification('Permissions updated successfully!', 'success');
        } catch (error) {
            console.error('Error updating permissions:', error);
            showNotification('Error updating permissions', 'error');
        }
    }

    // Close modals when clicking outside
    window.onclick = function (event) {
        const makeAdminModal = document.getElementById('makeAdminModal');
        const editPermissionsModal = document.getElementById('editPermissionsModal');
        if (event.target == makeAdminModal) {
            closeMakeAdminModal();
        }
        if (event.target == editPermissionsModal) {
            closeEditPermissionsModal();
        }
    }

    async function removeAdmin(userId) {
        showConfirmDialog(
            'Are you sure you want to remove admin rights from this user?',
            async () => {
                try {
                    const res = await fetch(`/admin/api/users/${userId}/remove-admin`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    if (!res.ok) await handleApiError(res);

                    loadUsers();
                    showNotification('Admin rights removed successfully!', 'success');
                } catch (error) {
                    console.error('Error removing admin rights:', error);
                    showNotification('Error removing admin rights', 'error');
                }
            }
        );
    }

    loadUsers();
</script>
{% endblock %}