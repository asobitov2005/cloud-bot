{% extends "base.html" %}

{% block files_active %}active{% endblock %}
{% block page_title %}Files Management{% endblock %}

{% block content %}
<div class="page-header">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search files..." oninput="searchFiles()" />
        <!-- <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i> -->
    </div>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th> 
                <th>File Size</th>
                <th>Downloads</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="filesTableBody">
            <tr>
                <td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i> Loading...</td>
            </tr>
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentFiles = [];
    let searchTimeout;
    let searchingMessage = null;

    async function loadFiles() {
        try {
            const res = await fetch(`/admin/api/files`, {
                credentials: 'same-origin'
            });
            if (!res.ok) await handleApiError(res);
            const data = await res.json();
            currentFiles = data.files;
            renderFiles(currentFiles);
        } catch (error) {
            console.error('Error loading files:', error);
        }
    }

    function renderFiles(files) {
        const tbody = document.getElementById('filesTableBody');
        
        // Remove searching message if it exists
        if (searchingMessage) {
            searchingMessage.remove();
            searchingMessage = null;
        }

        if (files.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No files found</td></tr>';
            return;
        }

        tbody.innerHTML = files.map(file => `
            <tr>
                <td>${file.id}</td>
                <td>${file.title}</td>
                <td>${file.file_size_formatted || '0 B'}</td>
                <td>${file.downloads_count}</td>
                <td>${new Date(file.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteFile(${file.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    // Debounced search function
    function searchFiles() {
        clearTimeout(searchTimeout);
        
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        
        // Show searching message if there's a query
        if (query !== '') {
            // Remove previous searching message if exists
            if (searchingMessage) {
                searchingMessage.remove();
            }
            
            // Create and show searching message
            const tbody = document.getElementById('filesTableBody');
            searchingMessage = document.createElement('tr');
            searchingMessage.id = 'searchingMessage';
            searchingMessage.innerHTML = `<td colspan="6" class="text-center" style="font-style: italic; color: #6b7280; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>Qidirilmoqda.....</td>`;
            tbody.innerHTML = '';
            tbody.appendChild(searchingMessage);
        } else {
            // Clear searching message if query is empty
            if (searchingMessage) {
                searchingMessage.remove();
                searchingMessage = null;
            }
            renderFiles(currentFiles);
            return;
        }
        
        searchTimeout = setTimeout(() => {
            const filtered = currentFiles.filter(f =>
                f.title.toLowerCase().includes(query)
            );
            
            // Remove searching message
            if (searchingMessage) {
                searchingMessage.remove();
                searchingMessage = null;
            }
            
            // Render results
            renderFiles(filtered);
        }, 300); // 300ms debounce
    }


    async function deleteFile(fileId) {
        showConfirmDialog(
            'Are you sure you want to delete this file? This action cannot be undone.',
            async () => {
                try {
                    const res = await fetch(`/admin/api/files/${fileId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    if (!res.ok) await handleApiError(res);

                    loadFiles();
                    showNotification('File deleted successfully!', 'success');
                } catch (error) {
                    console.error('Error deleting file:', error);
                    showNotification('Error deleting file', 'error');
                }
            }
        );
    }

    loadFiles();
</script>
{% endblock %}