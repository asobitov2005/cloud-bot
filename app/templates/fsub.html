{% extends "base.html" %}

{% block fsub_active %}active{% endblock %}
{% block page_title %}Force Join Channels{% endblock %}

{% block content %}
<div class="content-header">
    <h1><i class="fas fa-bullhorn"></i> Force Join Channels</h1>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-main);">Active Channels</h3>
        <button class="btn btn-primary" onclick="showAddChannelModal()">
            <i class="fas fa-plus"></i> Add Channel
        </button>
    </div>

    <div class="modern-table-container" style="box-shadow: none; border: 1px solid var(--border-color);">
        <table class="modern-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Username</th>
                    <th>Invite Link</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="fsubTableBody">
                <tr>
                    <td colspan="6" class="text-center" style="padding: 3rem;">
                        <i class="fas fa-spinner fa-spin"
                            style="margin-right: 0.5rem; color: var(--primary-color);"></i>
                        Loading channels...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Add Channel Modal -->
<div id="addChannelModal" class="modal"
    style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px);">
    <div class="modal-content"
        style="background-color: var(--bg-card); margin: 10% auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); position: relative;">
        <span class="close" onclick="closeAddChannelModal()"
            style="color: var(--text-muted); float: right; font-size: 1.5rem; font-weight: bold; cursor: pointer;">&times;</span>
        <h2 style="margin-bottom: 1.5rem; color: var(--text-main);">Add New Channel</h2>
        <form id="addChannelForm" onsubmit="addChannel(event)">
            <div style="margin-bottom: 1.5rem;">
                <label for="channelId"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-main); font-weight: 500;">Channel ID
                    / Username</label>
                <input type="text" id="channelId" placeholder="@channel or -100..."
                    style="width: 100%; padding: 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-main);">
                <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">Bot must be admin in the
                    channel</small>
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="inviteLink"
                    style="display: block; margin-bottom: 0.5rem; color: var(--text-main); font-weight: 500;">Invite
                    Link</label>
                <input type="text" id="inviteLink" placeholder="https://t.me/..."
                    style="width: 100%; padding: 0.75rem; border-radius: var(--radius-md); border: 1px solid var(--border-color); background-color: var(--bg-input); color: var(--text-main);">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeAddChannelModal()" class="btn"
                    style="background-color: var(--bg-input); color: var(--text-main);">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Channel</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentChannels = [];

    async function loadFsubChannels() {
        try {
            const response = await fetch('/admin/api/fsub', {
                headers: {
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });
            if (!response.ok) await handleApiError(response);
            const data = await response.json();
            currentChannels = data.channels || [];
            renderChannels(currentChannels);
        } catch (error) {
            console.error('Error loading channels:', error);
            showNotification('Error loading channels', 'error');
        }
    }

    function renderChannels(channels) {
        const tbody = document.getElementById('fsubTableBody');

        if (!channels || channels.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-muted);">
                        <i class="fas fa-bullhorn" style="font-size: 2rem; margin-bottom: 1rem; display: block; opacity: 0.5;"></i>
                        No force join channels configured
                    </td>
                </tr>`;
            return;
        }

        tbody.innerHTML = channels.map(channel => `
            <tr>
                <td>${channel.channel_id}</td>
                <td>${channel.channel_title || 'N/A'}</td>
                <td>${channel.channel_username ? '@' + channel.channel_username : 'N/A'}</td>
                <td>${channel.invite_link ? `<a href="${channel.invite_link}" target="_blank">Link</a>` : 'N/A'}</td>
                <td><span class="badge badge-success">Active</span></td>
                <td>
                    <button class="action-btn" onclick="removeChannel(${channel.channel_id})" title="Remove Channel" style="color: #ef4444;">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function showAddChannelModal() {
        document.getElementById('addChannelModal').style.display = 'block';
    }

    function closeAddChannelModal() {
        document.getElementById('addChannelModal').style.display = 'none';
        // Clear all form fields
        const channelIdInput = document.getElementById('channelId');
        const inviteLinkInput = document.getElementById('inviteLink');
        if (channelIdInput) channelIdInput.value = '';
        if (inviteLinkInput) inviteLinkInput.value = '';
    }

    async function addChannel(event) {
        event.preventDefault();

        const channelIdInput = document.getElementById('channelId');
        const inviteLinkInput = document.getElementById('inviteLink');

        const channelId = channelIdInput ? channelIdInput.value.trim() : '';
        const inviteLink = inviteLinkInput ? inviteLinkInput.value.trim() : '';

        if (!channelId && !inviteLink) {
            showNotification('Please provide Channel ID/Username or Invite Link', 'error');
            return;
        }

        try {
            const response = await fetch('/admin/api/fsub', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    channel_id: channelId || null,
                    channel_username: channelId.startsWith('@') ? channelId : null,
                    invite_link: inviteLink || null
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Failed to add channel');
            }

            showNotification('Channel added successfully', 'success');
            closeAddChannelModal();
            loadFsubChannels();
        } catch (error) {
            console.error('Error adding channel:', error);
            showNotification(error.message || 'Error adding channel', 'error');
        }
    }

    async function removeChannel(channelId) {
        showConfirmDialog(
            'Are you sure you want to remove this channel?',
            async () => {
                try {
                    const response = await fetch(`/admin/api/fsub/${channelId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });

                    if (!response.ok) await handleApiError(response);

                    showNotification('Channel removed successfully', 'success');
                    loadFsubChannels();
                } catch (error) {
                    console.error('Error removing channel:', error);
                    showNotification('Error removing channel', 'error');
                }
            }
        );
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('addChannelModal');
        if (event.target == modal) {
            closeAddChannelModal();
        }
    }

    // Load channels on page load
    document.addEventListener('DOMContentLoaded', loadFsubChannels);
</script>
{% endblock %}